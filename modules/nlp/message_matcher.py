import re
from typing import Optional, Dict, List
from modules.core.logger import logger

# ðŸ” à¸£à¸§à¸¡ pattern à¸—à¸µà¹ˆ compile à¹à¸¥à¹‰à¸§à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£ match à¸«à¸±à¸§à¸‚à¹‰à¸­
TOPIC_PATTERNS: Dict[str, List[re.Pattern]] = {
    topic: [re.compile(pattern, re.IGNORECASE) for pattern in patterns]
    for topic, patterns in {
        "oil": [
            r"à¸£à¸²à¸„à¸²à¸™à¹‰à¸³à¸¡à¸±à¸™", r"à¸™à¹‰à¸³à¸¡à¸±à¸™.*à¸§à¸±à¸™à¸™à¸µà¹‰", r"à¸™à¹‰à¸³à¸¡à¸±à¸™à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ",
            r"à¸•à¸­à¸™à¸™à¸µà¹‰.*à¸™à¹‰à¸³à¸¡à¸±à¸™", r"à¹€à¸šà¸™à¸‹à¸´à¸™", r"à¸”à¸µà¹€à¸‹à¸¥"
        ],
        "gold": [
            r"à¸£à¸²à¸„à¸²à¸—à¸­à¸‡", r"à¸—à¸­à¸‡.*à¸§à¸±à¸™à¸™à¸µà¹‰", r"à¸—à¸­à¸‡à¸‚à¸¶à¹‰à¸™", r"à¸—à¸­à¸‡à¸¥à¸‡",
            r"à¸—à¸­à¸‡à¸„à¸³à¹à¸—à¹ˆà¸‡", r"gold"
        ],
        "lotto": [
            r"à¸«à¸§à¸¢", r"à¸ªà¸¥à¸²à¸à¸à¸´à¸™à¹à¸šà¹ˆà¸‡", r"à¸œà¸¥.*à¸«à¸§à¸¢",
            r"à¸•à¸£à¸§à¸ˆ.*à¸«à¸§à¸¢", r"à¹€à¸¥à¸‚.*à¸­à¸­à¸"
        ],
        "exchange": [
            r"à¹à¸¥à¸à¹€à¸‡à¸´à¸™", r"à¸­à¸±à¸•à¸£à¸²à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™", r"à¸„à¹ˆà¸²à¹€à¸‡à¸´à¸™",
            r"à¹€à¸£à¸—à¹€à¸‡à¸´à¸™", r"exchange"
        ],
        "weather": [
            r"à¸­à¸²à¸à¸²à¸¨", r"à¸žà¸¢à¸²à¸à¸£à¸“à¹Œà¸­à¸²à¸à¸²à¸¨", r"à¸à¸™à¸•à¸",
            r"à¸­à¸¸à¸“à¸«à¸ à¸¹à¸¡à¸´", r"à¸Ÿà¹‰à¸²", r"weather"
        ],
        "global_news": [
            r"à¸‚à¹ˆà¸²à¸§à¸•à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨", r"à¸‚à¹ˆà¸²à¸§à¸ˆà¸²à¸à¸•à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨", r"à¸‚à¹ˆà¸²à¸§à¸—à¸±à¹ˆà¸§à¹‚à¸¥à¸",
            r"à¸‚à¹ˆà¸²à¸§à¹€à¸¡à¸·à¸­à¸‡à¸™à¸­à¸", r"à¸‚à¹ˆà¸²à¸§à¹‚à¸¥à¸", r"international news", r"world news"
        ],
        "news": [
            r"(à¸‚à¹ˆà¸²à¸§à¸”à¹ˆà¸§à¸™|à¸‚à¹ˆà¸²à¸§à¸§à¸±à¸™à¸™à¸µà¹‰|à¸‚à¹ˆà¸²à¸§à¹€à¸”à¹ˆà¸™|à¸‚à¹ˆà¸²à¸§à¸¥à¹ˆà¸²à¸ªà¸¸à¸”|à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹ˆà¸²à¸§)",
            r"à¸‚à¹ˆà¸²à¸§(?:à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸š|à¸‚à¸­à¸‡|à¸¥à¹ˆà¸²à¸ªà¸¸à¸”|à¹ƒà¸™à¸«à¸±à¸§à¸‚à¹‰à¸­|à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š)\s.+",
            r"à¸‚à¸­à¸ªà¸£à¸¸à¸›à¸‚à¹ˆà¸²à¸§", r"à¸Šà¹ˆà¸§à¸¢à¸­à¸±à¸›à¹€à¸”à¸•à¸‚à¹ˆà¸²à¸§", r"à¹€à¸¥à¹ˆà¸²à¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œà¸§à¸±à¸™à¸™à¸µà¹‰"
        ],
        "tarot": [
            r"à¸”à¸¹à¸”à¸§à¸‡", r"à¹€à¸›à¸´à¸”à¹„à¸žà¹ˆ", r"à¹„à¸žà¹ˆà¸¢à¸´à¸›à¸‹à¸µ", r"à¹„à¸žà¹ˆ", r"à¸—à¸³à¸™à¸²à¸¢"
        ],
        "image": [
            r"^à¸”à¸¹à¸£à¸¹à¸›", r"^à¸„à¹‰à¸™à¸£à¸¹à¸›", r"à¸«à¸²à¸£à¸¹à¸›", r"à¸‚à¸­à¸£à¸¹à¸›", r"à¸£à¸¹à¸›à¸ à¸²à¸ž"
        ]
    }.items()
}

# âœ… à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ˆà¸±à¸šà¸«à¸±à¸§à¸‚à¹‰à¸­à¸ˆà¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
def match_topic(text: str) -> Optional[str]:
    text = text.strip()
    for topic, patterns in TOPIC_PATTERNS.items():
        for pattern in patterns:
            if pattern.search(text):
                logger.info(f"âœ… à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆ match: '{topic}' à¸”à¹‰à¸§à¸¢ pattern '{pattern.pattern}'")
                return topic
    logger.info("âŒ à¹„à¸¡à¹ˆà¸žà¸šà¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆ match à¸à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡")
    return None

# âœ… DEBUG: à¸¢à¸·à¸™à¸¢à¸±à¸™à¸§à¹ˆà¸²à¹„à¸Ÿà¸¥à¹Œà¹‚à¸«à¸¥à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
if __name__ == "__main__":
    test_texts = [
        "à¸­à¸¢à¸²à¸à¸£à¸¹à¹‰à¸£à¸²à¸„à¸²à¸™à¹‰à¸³à¸¡à¸±à¸™à¸§à¸±à¸™à¸™à¸µà¹‰",
        "à¸‚à¹ˆà¸²à¸§à¸•à¹ˆà¸²à¸‡à¸›à¸£à¸°à¹€à¸—à¸¨à¸§à¸±à¸™à¸™à¸µà¹‰",
        "à¸‚à¸­à¸£à¸¹à¸›à¹à¸¡à¸§à¸•à¸¥à¸",
        "à¸Šà¹ˆà¸§à¸¢à¸•à¸£à¸§à¸ˆà¸«à¸§à¸¢à¹ƒà¸«à¹‰à¸«à¸™à¹ˆà¸­à¸¢",
        "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²"
    ]
    for txt in test_texts:
        result = match_topic(txt)
        print(f"'{txt}' => à¸«à¸±à¸§à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¹„à¸”à¹‰: {result}")
    print("âœ… message_matcher.py à¹‚à¸«à¸¥à¸”à¸ªà¸³à¹€à¸£à¹‡à¸ˆ")
